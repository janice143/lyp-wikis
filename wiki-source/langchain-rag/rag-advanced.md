# **ç¬¬äº”ç« ï¼šRAG è¿›é˜¶ä¼˜åŒ–**

åŸºç¡€ RAG ç³»ç»Ÿèƒ½å¤Ÿæ‰§è¡ŒåŸºæœ¬çš„æ£€ç´¢ä¸ç”Ÿæˆä»»åŠ¡ï¼Œä½†åœ¨å®é™…åº”ç”¨ä¸­ï¼Œç³»ç»Ÿçš„**æ£€ç´¢å‡†ç¡®æ€§ã€ç”Ÿæˆè´¨é‡å’Œæ€§èƒ½**ä»æœ‰å¾ˆå¤§çš„ä¼˜åŒ–ç©ºé—´ã€‚æœ¬ç« å°†ä»‹ç» RAG è¿›é˜¶ä¼˜åŒ–ç­–ç•¥ï¼ŒåŒ…æ‹¬ï¼š
âœ… **æå‡æ£€ç´¢æ•ˆæœ**ï¼ˆåŠ¨æ€ Top-K é€‰æ‹©ã€Rerankingï¼‰  
âœ… **ä¼˜åŒ–ç”Ÿæˆéƒ¨åˆ†**ï¼ˆè‡ªé€‚åº” Prompt è®¾è®¡ã€Few-shot æç¤ºï¼‰  
âœ… **ç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–**ï¼ˆRedis / LlamaIndex ç¼“å­˜ã€é¢„è®¡ç®—åµŒå…¥ï¼‰  
âœ… **é•¿æ–‡æœ¬å¤„ç†**ï¼ˆRecursive Text Splitting, Sliding Windowï¼‰  

---

## **1. æå‡æ£€ç´¢æ•ˆæœ**

æ£€ç´¢æ˜¯ RAG ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œå¦‚æœæ£€ç´¢ä¸åˆ°é«˜è´¨é‡çš„ä¸Šä¸‹æ–‡ï¼ŒLLM ä¹Ÿæ— æ³•ç”Ÿæˆå‡†ç¡®çš„å›ç­”ã€‚æœ¬èŠ‚ä»‹ç»åŠ¨æ€ Top-K é€‰æ‹©å’Œ Rerankingï¼ˆé‡æ’åºï¼‰ä¼˜åŒ–æ£€ç´¢æ•ˆæœã€‚

### **1.1 åŠ¨æ€ Top-K é€‰æ‹©**

**é—®é¢˜ï¼š**

- é€‰æ‹©è¿‡å¤šçš„æ£€ç´¢æ–‡æ¡£ä¼šå¯¼è‡´æ— å…³ä¿¡æ¯å¹²æ‰° LLMã€‚
- é€‰æ‹©è¿‡å°‘å¯èƒ½å¯¼è‡´å…³é”®ä¿¡æ¯ç¼ºå¤±ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
åŠ¨æ€è°ƒæ•´ `Top-K`ï¼ˆæ£€ç´¢è¿”å›çš„æ–‡æ¡£æ•°é‡ï¼‰ï¼Œæ ¹æ® **æŸ¥è¯¢ç±»å‹** æˆ– **æ–‡æœ¬ç›¸ä¼¼åº¦åˆ†æ•°** è®¾å®šæœ€ä¼˜ K å€¼ã€‚

```python
def dynamic_top_k(retriever, query, max_k=10, threshold=0.75):
    docs = retriever.get_relevant_documents(query, k=max_k)
    filtered_docs = [doc for doc in docs if doc.metadata['score'] >= threshold]
    return filtered_docs[:len(filtered_docs) or 3]  # ç¡®ä¿è‡³å°‘è¿”å› 3 ä¸ª
```

---

### **1.2 Rerankingï¼ˆé‡æ’åºï¼‰**

**é—®é¢˜ï¼š**

- å‘é‡æ£€ç´¢å¯èƒ½è¿”å›ç›¸å…³æ€§è¾ƒä½çš„æ–‡æ¡£ã€‚
- éœ€è¦é¢å¤–çš„æ’åºé€»è¾‘æå‡å‡†ç¡®æ€§ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
ä½¿ç”¨ **Cross-Encoderï¼ˆå¦‚ Cohere Rerankerï¼‰** è¿›è¡Œé‡æ–°æ’åºï¼Œç¡®ä¿æ›´ä¼˜çš„ä¸Šä¸‹æ–‡æ’åœ¨å‰é¢ã€‚

#### **ä½¿ç”¨ Cohere Reranker**

```python
from langchain.embeddings.cohere import CohereReranker

reranker = CohereReranker(model="rerank-english-v2.0")
reranked_docs = reranker.rerank(query, retrieved_docs)
```

è¿™ç§æ–¹å¼å¯ä»¥è®©çœŸæ­£é‡è¦çš„ä¿¡æ¯æ’åœ¨å‰é¢ï¼Œæé«˜ LLM ç”Ÿæˆçš„å‡†ç¡®æ€§ã€‚

---

## **2. ä¼˜åŒ–ç”Ÿæˆéƒ¨åˆ†**

å³ä½¿æ£€ç´¢ç»“æœå¾ˆç²¾å‡†ï¼Œ**LLM çš„å›ç­”è´¨é‡** ä»ç„¶å— **Prompt è®¾è®¡** å’Œ **ä¸Šä¸‹æ–‡æ§åˆ¶** å½±å“ã€‚æœ¬èŠ‚ä»‹ç»å¦‚ä½•æ”¹è¿› Prompt è®¾è®¡ï¼Œä½¿ç”Ÿæˆç»“æœæ›´ç¨³å®šã€‚

### **2.1 è‡ªé€‚åº” Prompt è®¾è®¡**

**é—®é¢˜ï¼š**

- ç»Ÿä¸€ Prompt å¯èƒ½æ— æ³•é€‚åº”ä¸åŒç±»å‹çš„æŸ¥è¯¢ã€‚
- éœ€è¦é’ˆå¯¹ä¸åŒä»»åŠ¡åŠ¨æ€è°ƒæ•´ Promptã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
æ ¹æ®æŸ¥è¯¢ç±»å‹è°ƒæ•´ Promptï¼Œä¾‹å¦‚ï¼š

- **å®šä¹‰é—®é¢˜çš„é¢†åŸŸ**ï¼ˆåŒ»å­¦ / æ³•å¾‹ / æŠ€æœ¯ï¼‰ã€‚
- **æ˜ç¡®å›ç­”çš„æ ¼å¼**ï¼ˆåˆ—è¡¨ / è¯¦ç»†è§£æ / æ‘˜è¦ï¼‰ã€‚

#### **ç¤ºä¾‹ï¼šè‡ªé€‚åº” Prompt**

```python
from langchain.prompts import PromptTemplate

def generate_prompt(query, context):
    if "æ³•å¾‹" in query:
        template = "æ ¹æ®ä»¥ä¸‹æ³•å¾‹ä¿¡æ¯ï¼š{context}ï¼Œè¯·æä¾›ä¸“ä¸šæ³•å¾‹è§£è¯»ã€‚é—®é¢˜ï¼š{query}"
    else:
        template = "è¯·åŸºäºä»¥ä¸‹ä¿¡æ¯å›ç­”é—®é¢˜ï¼š{context}ï¼Œé—®é¢˜ï¼š{query}"
    return PromptTemplate(template=template).format(context=context, query=query)
```

---

### **2.2 Few-shot æç¤ºä¼˜åŒ–**

**é—®é¢˜ï¼š**

- Zero-shot å¯èƒ½å¯¼è‡´æ¨¡å‹æ— æ³•ç†è§£ä»»åŠ¡ã€‚
- éœ€è¦æä¾›ç¤ºä¾‹ï¼ˆFew-shot Learningï¼‰ä»¥æé«˜å›ç­”è´¨é‡ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
åœ¨ Prompt ä¸­æ·»åŠ ç¤ºä¾‹ï¼Œä½¿ LLM å‚è€ƒè¿‡å»çš„é«˜è´¨é‡ç­”æ¡ˆã€‚

```python
few_shot_prompt = """ç¤ºä¾‹ï¼š
ç”¨æˆ·ï¼šå¦‚ä½•ä¼˜åŒ– RAG ç³»ç»Ÿï¼Ÿ
AIï¼šå¯ä»¥ä½¿ç”¨åŠ¨æ€ Top-Kã€Reranking å’Œç¼“å­˜ä¼˜åŒ–ã€‚

ç”¨æˆ·ï¼š{query}
AIï¼š
"""
```

è¿™ç§æ–¹å¼å¯ä»¥ **æ˜¾è‘—æå‡ LLM çš„å›ç­”ä¸€è‡´æ€§**ã€‚

---

## **3. ç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–**

è°ƒç”¨å¤§æ¨¡å‹ï¼ˆå¦‚ GPT-4ï¼‰æˆæœ¬è¾ƒé«˜ï¼Œå¹¶ä¸”å“åº”é€Ÿåº¦å¯èƒ½è¾ƒæ…¢ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ **ç¼“å­˜** æœºåˆ¶å‡å°‘ API è°ƒç”¨æ¬¡æ•°ï¼Œå¹¶ä¼˜åŒ–åµŒå…¥å­˜å‚¨ã€‚

### **3.1 ä½¿ç”¨ Redis è¿›è¡Œç¼“å­˜**

ä½¿ç”¨ **Redis** å­˜å‚¨æŸ¥è¯¢çš„å†å²ç»“æœï¼Œå‡å°‘é‡å¤è®¡ç®—ã€‚

#### **å®‰è£… Redis**

```bash
pip install redis
```

#### **ç¼“å­˜æŸ¥è¯¢ç»“æœ**

```python
import redis
import json

cache = redis.Redis(host='localhost', port=6379, db=0)

def get_cached_response(query):
    return cache.get(query)

def save_to_cache(query, response):
    cache.set(query, json.dumps(response), ex=3600)  # 1å°æ—¶è¿‡æœŸ
```

**æ•ˆæœ**ï¼š

- **å‡å°‘ API è°ƒç”¨æˆæœ¬**ï¼ŒåŠ é€Ÿå“åº”æ—¶é—´ã€‚
- **ç¼“å­˜é«˜é¢‘æŸ¥è¯¢**ï¼Œé¿å…é‡å¤è®¡ç®—ã€‚

---

### **3.2 é¢„è®¡ç®—åµŒå…¥å‡å°‘ API è°ƒç”¨**

åµŒå…¥è®¡ç®—ï¼ˆEmbeddingï¼‰é€šå¸¸ä¼šå ç”¨å¤§é‡ API è´¹ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ **é¢„è®¡ç®—** é‡è¦æ–‡æœ¬çš„åµŒå…¥ï¼Œå¹¶å­˜å‚¨åˆ°å‘é‡æ•°æ®åº“ã€‚

```python
from langchain.vectorstores import FAISS
from langchain.embeddings.openai import OpenAIEmbeddings

# è®¡ç®—å¹¶å­˜å‚¨åµŒå…¥
texts = ["RAG æ˜¯ä»€ä¹ˆï¼Ÿ", "å¦‚ä½•ä¼˜åŒ– RAGï¼Ÿ"]
embeddings = OpenAIEmbeddings()
vector_store = FAISS.from_texts(texts, embedding=embeddings)

# æŸ¥è¯¢æ—¶ç›´æ¥æ£€ç´¢å·²æœ‰åµŒå…¥
retriever = vector_store.as_retriever()
retrieved_docs = retriever.get_relevant_documents("RAG çš„ä½œç”¨ï¼Ÿ")
```

**ä¼˜åŠ¿**ï¼š

- **å‡å°‘ API è°ƒç”¨**ï¼Œé™ä½ OpenAI è´¹ç”¨ã€‚
- **æŸ¥è¯¢é€Ÿåº¦æ›´å¿«**ï¼Œæé«˜å“åº”æ•ˆç‡ã€‚

---

## **4. é•¿æ–‡æœ¬å¤„ç†ä¼˜åŒ–**

å½“æ–‡æ¡£è¾ƒé•¿æ—¶ï¼Œç›´æ¥å°†å…¨éƒ¨å†…å®¹è¾“å…¥ LLM **ä¸å¯è¡Œ**ï¼Œå› ä¸ºä¼šè¶…å‡º Token é™åˆ¶ã€‚æœ¬èŠ‚ä»‹ç» **é€’å½’æ–‡æœ¬åˆ‡åˆ†** å’Œ **æ»‘åŠ¨çª—å£ç­–ç•¥** å¤„ç†é•¿æ–‡æœ¬ã€‚

### **4.1 Recursive Text Splittingï¼ˆé€’å½’æ–‡æœ¬åˆ‡åˆ†ï¼‰**

å°†æ–‡æœ¬æŒ‰ç…§ **å±‚çº§** è¿›è¡Œåˆ‡åˆ†ï¼ˆå¦‚æŒ‰ç« èŠ‚ â†’ æ®µè½ â†’ å¥å­ï¼‰ï¼Œç¡®ä¿å†…å®¹ç»“æ„å®Œæ•´ã€‚

```python
from langchain.text_splitter import RecursiveCharacterTextSplitter

splitter = RecursiveCharacterTextSplitter(chunk_size=512, chunk_overlap=50)
chunks = splitter.split_text("è¿™æ˜¯ä¸€æ®µé•¿æ–‡æœ¬...")
```

**ä¼˜åŠ¿**ï¼š

- **å‡å°‘ä¿¡æ¯ä¸¢å¤±**ï¼Œæ¯”å›ºå®šåˆ‡åˆ†æ–¹å¼æ›´æ™ºèƒ½ã€‚
- **æå‡æ£€ç´¢æ•ˆæœ**ï¼Œè®©æ¯ä¸ª chunk å…·å¤‡æ›´å®Œæ•´çš„è¯­ä¹‰ä¿¡æ¯ã€‚

---

### **4.2 Sliding Windowï¼ˆæ»‘åŠ¨çª—å£ï¼‰**

ä½¿ç”¨ **æ»‘åŠ¨çª—å£**ï¼ˆSliding Windowï¼‰ç¡®ä¿ç›¸é‚»æ–‡æœ¬å—æœ‰ä¸€å®š **é‡å **ï¼Œè®© LLM ä»ç„¶èƒ½ä¿æŒä¸Šä¸‹æ–‡ã€‚

```python
def sliding_window_split(text, window_size=512, overlap=100):
    chunks = []
    for i in range(0, len(text), window_size - overlap):
        chunks.append(text[i:i + window_size])
    return chunks
```

**ä¼˜åŠ¿**ï¼š

- **å‡å°‘ä¸Šä¸‹æ–‡æ–­è£‚**ï¼Œè®© LLM ç”Ÿæˆæ›´è‡ªç„¶çš„ç­”æ¡ˆã€‚
- **é€‚ç”¨äºæ³•å¾‹ã€åŒ»å­¦ã€é•¿è®ºæ–‡ç­‰å¤æ‚æ–‡æ¡£**ã€‚

---

## **æ€»ç»“**

æœ¬ç« ä»‹ç»äº† RAG è¿›é˜¶ä¼˜åŒ–çš„æ ¸å¿ƒæŠ€æœ¯ï¼š
âœ… **æå‡æ£€ç´¢æ•ˆæœ**ï¼šåŠ¨æ€ Top-K é€‰æ‹©ã€Reranking é‡æ’åº  
âœ… **ä¼˜åŒ–ç”Ÿæˆéƒ¨åˆ†**ï¼šè‡ªé€‚åº” Promptã€Few-shot æç¤ºæå‡ LLM è´¨é‡  
âœ… **ç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–**ï¼šRedis ç¼“å­˜ã€é¢„è®¡ç®—åµŒå…¥å‡å°‘ API è´¹ç”¨  
âœ… **é•¿æ–‡æœ¬å¤„ç†**ï¼šRecursive Text Splittingã€Sliding Window è§£å†³ Token é™åˆ¶  

åœ¨ä¸‹ä¸€ç« èŠ‚ï¼Œæˆ‘ä»¬å°†æ¢è®¨ **RAG åœ¨å®é™…åº”ç”¨ä¸­çš„æ¡ˆä¾‹åˆ†æ**ï¼ŒåŒ…æ‹¬å¦‚ä½•è½åœ°åˆ° **ä¼ä¸šçŸ¥è¯†åº“ã€æ™ºèƒ½å®¢æœã€æ³•å¾‹é—®ç­”ç­‰ä¸šåŠ¡åœºæ™¯**ï¼ ğŸš€
